<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ãƒ¼ãƒ³è¨ˆç®—æ©Ÿ GUI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .controls-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .controls-header h2 {
            color: #2c3e50;
            font-size: 1.8em;
        }

        .scenario-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .scenario-selector select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            min-width: 200px;
        }

        .scenario-selector button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .scenario-selector button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .input-group input, .input-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-group label {
            font-size: 1.1em;
            color: #2c3e50;
            cursor: pointer;
        }

        .calculate-button {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .calculate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .results-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .results-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .results-header h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 25px;
            background: #f8f9fa;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .summary-card:hover {
            transform: translateY(-3px);
        }

        .summary-card .label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-card .value {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
        }

        .deduction-summary {
            background: #e8f5e8;
            border-left: 4px solid #27ae60;
            padding: 20px;
            margin: 20px;
            border-radius: 0 10px 10px 0;
        }

        .deduction-summary h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .deduction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .deduction-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #27ae60;
        }

        .table-container {
            padding: 25px;
            overflow-x: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }

        .results-table th,
        .results-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #2c3e50;
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 0.9em;
        }

        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .results-table tr:hover {
            background: #e3f2fd;
        }

        .results-table td:first-child {
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
        }

        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-cards {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .controls-header {
                flex-direction: column;
                gap: 15px;
            }

            .scenario-selector {
                width: 100%;
                justify-content: center;
            }

            .results-table {
                font-size: 0.85em;
            }

            .results-table th,
            .results-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ  ãƒ­ãƒ¼ãƒ³è¨ˆç®—æ©Ÿ</h1>
            <p>å€Ÿå…¥é‡‘é¡ã€é‡‘åˆ©ã€æœŸé–“ã‹ã‚‰æœˆé¡è¿”æ¸ˆé¡ã¨å¹´ã”ã¨ã®æ®‹é‡‘ã‚’è¨ˆç®—ã—ã¾ã™</p>
        </div>

        <div class="content">
            <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="controls-section">
                <div class="controls-header">
                    <h2>ğŸ“Š è¨ˆç®—æ¡ä»¶è¨­å®š</h2>
                    <div class="scenario-selector">
                        <select id="scenarioSelect">
                            <option value="">ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠ...</option>
                        </select>
                        <button onclick="loadScenario()">èª­è¾¼</button>
                    </div>
                </div>

                <div class="input-grid">
                    <div class="input-group">
                        <label for="loanAmount">ğŸ’° å€Ÿå…¥é‡‘é¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="loanAmount" value="30000000" step="100000">
                    </div>
                    <div class="input-group">
                        <label for="annualRate">ğŸ“ˆ å¹´åˆ©ç‡ï¼ˆ%ï¼‰</label>
                        <input type="number" id="annualRate" value="1.5" step="0.1" min="0">
                    </div>
                    <div class="input-group">
                        <label for="years">ğŸ“… å€Ÿå…¥æœŸé–“ï¼ˆå¹´ï¼‰</label>
                        <input type="number" id="years" value="35" step="1" min="1" max="50">
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="hasDeduction" checked>
                    <label for="hasDeduction">ğŸ¡ ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ã‚’é©ç”¨ã™ã‚‹ï¼ˆ13å¹´é–“ã€å¹´æœ«æ®‹é«˜ã¾ãŸã¯4500ä¸‡å††ã®å°‘ãªã„æ–¹ã®0.7%ï¼‰</label>
                </div>

                <button class="calculate-button" onclick="calculateLoan()">
                    ğŸ§® ãƒ­ãƒ¼ãƒ³è¨ˆç®—ã‚’å®Ÿè¡Œ
                </button>
            </div>

            <!-- çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="results-section" id="results" style="display: none;">
                <div class="results-header">
                    <h2>ğŸ“‹ ãƒ­ãƒ¼ãƒ³è¨ˆç®—çµæœ</h2>
                    <p id="resultsSummaryText"></p>
                </div>

                <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="label">æœˆé¡è¿”æ¸ˆé¡</div>
                        <div class="value" id="monthlyPayment">-</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">ç·æ”¯æ‰•é¡</div>
                        <div class="value" id="totalPayment">-</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">ç·åˆ©æ¯é¡</div>
                        <div class="value" id="totalInterest">-</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">ç·æ§é™¤é¡</div>
                        <div class="value" id="totalDeduction">-</div>
                    </div>
                    <div class="summary-card">
                        <div class="label">å®Ÿè³ªè² æ‹…é¡</div>
                        <div class="value" id="actualPayment">-</div>
                    </div>
                </div>

                <!-- ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤ã‚µãƒãƒªãƒ¼ -->
                <div class="deduction-summary" id="deductionSummary" style="display: none;">
                    <h3>ğŸ¡ ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤æœŸé–“ï¼ˆ13å¹´é–“ï¼‰ã®è©³ç´°</h3>
                    <div class="deduction-grid">
                        <div class="deduction-item">
                            <span>13å¹´é–“ã®ç·æ”¯æ‰•é¡:</span>
                            <span id="deduction13TotalPayment">-</span>
                        </div>
                        <div class="deduction-item">
                            <span>13å¹´é–“ã®ç·åˆ©æ¯é¡:</span>
                            <span id="deduction13TotalInterest">-</span>
                        </div>
                        <div class="deduction-item">
                            <span>13å¹´é–“ã®ç·æ§é™¤é¡:</span>
                            <span id="deduction13TotalDeduction">-</span>
                        </div>
                        <div class="deduction-item">
                            <span>13å¹´é–“ã®å®Ÿè³ªè² æ‹…é¡:</span>
                            <span id="deduction13ActualPayment">-</span>
                        </div>
                        <div class="deduction-item">
                            <span>13å¹´ç›®çµ‚äº†æ™‚ã®æ®‹å‚µé¡:</span>
                            <span id="deduction13RemainingBalance">-</span>
                        </div>
                    </div>
                </div>

                <!-- å¹´æ¬¡ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #2c3e50;">ğŸ“ˆ å¹´ã”ã¨ã®è¿”æ¸ˆè¨ˆç”»</h3>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="exportToCSV()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;">
                                ğŸ“Š CSVå‡ºåŠ›
                            </button>
                            <button onclick="toggleChart()" style="background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;" id="chartToggleBtn">
                                ğŸ“ˆ ã‚°ãƒ©ãƒ•è¡¨ç¤º
                            </button>
                        </div>
                    </div>
                    
                    <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
                    <div id="chartContainer" style="display: none; margin-bottom: 20px;">
                        <canvas id="loanChart" width="800" height="400"></canvas>
                    </div>
                    
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th>å¹´</th>
                                <th>å¹´é–“è¿”æ¸ˆé¡</th>
                                <th>å…ƒæœ¬è¿”æ¸ˆé¡</th>
                                <th>åˆ©æ¯æ”¯æ‰•é¡</th>
                                <th>æ®‹å‚µé¡</th>
                                <th id="deductionColumn" style="display: none;">ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
        let configData = null;
        let currentYearlyData = null;
        let loanChart = null;

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', function() {
            loadConfigFile();
        });

        // è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        async function loadConfigFile() {
            try {
                const response = await fetch('./loan-config.json');
                if (!response.ok) {
                    throw new Error('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                configData = await response.json();
                populateScenarios();
            } catch (error) {
                console.error('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨
                configData = {
                    defaultConfig: {
                        loanAmount: 30000000,
                        annualRate: 1.5,
                        years: 35,
                        hasDeduction: false,
                        description: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š"
                    },
                    scenarios: []
                };
                populateScenarios();
            }
        }

        // ã‚·ãƒŠãƒªã‚ªé¸æŠè‚¢ã‚’è¿½åŠ 
        function populateScenarios() {
            const select = document.getElementById('scenarioSelect');
            select.innerHTML = '<option value="">ã‚·ãƒŠãƒªã‚ªã‚’é¸æŠ...</option>';
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’è¿½åŠ 
            const defaultOption = document.createElement('option');
            defaultOption.value = 'default';
            defaultOption.textContent = `ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š - ${configData.defaultConfig.description}`;
            select.appendChild(defaultOption);

            // å„ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ 
            configData.scenarios.forEach((scenario, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${scenario.name} - ${scenario.description}`;
                select.appendChild(option);
            });
        }

        // é¸æŠã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªã‚’èª­ã¿è¾¼ã‚€
        function loadScenario() {
            const select = document.getElementById('scenarioSelect');
            const selectedValue = select.value;
            
            if (selectedValue === '') return;
            
            let config;
            if (selectedValue === 'default') {
                config = configData.defaultConfig;
            } else {
                config = configData.scenarios[parseInt(selectedValue)];
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('loanAmount').value = config.loanAmount;
            document.getElementById('annualRate').value = config.annualRate;
            document.getElementById('years').value = config.years;
            document.getElementById('hasDeduction').checked = config.hasDeduction;
            
            // è‡ªå‹•è¨ˆç®—
            calculateLoan();
        }

        // æ•°å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
        function formatNumber(num) {
            return Math.round(num).toLocaleString();
        }

        // æœˆé¡è¿”æ¸ˆé¡ã‚’è¨ˆç®—
        function calculateMonthlyPayment(loanAmount, annualRate, years) {
            const monthlyRate = annualRate / 100 / 12;
            const numberOfPayments = years * 12;
            
            if (monthlyRate === 0) {
                return loanAmount / numberOfPayments;
            }
            
            return loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) /
                   (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
        }

        // ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤é¡ã‚’è¨ˆç®—
        function calculateLoanDeduction(remainingBalance, year, hasDeduction) {
            if (!hasDeduction || year > 13) {
                return 0;
            }
            const deductionBase = Math.min(remainingBalance, 45000000);
            return deductionBase * 0.007;
        }

        // å¹´ã”ã¨ã®æ®‹é‡‘ã‚’è¨ˆç®—
        function calculateYearlyBalance(loanAmount, monthlyPayment, annualRate, years, hasDeduction) {
            const monthlyRate = annualRate / 100 / 12;
            let remainingBalance = loanAmount;
            const yearlyData = [];

            for (let year = 1; year <= years; year++) {
                let yearlyPrincipal = 0;
                let yearlyInterest = 0;

                for (let month = 1; month <= 12; month++) {
                    if (remainingBalance <= 0) break;

                    const interestPayment = remainingBalance * monthlyRate;
                    const principalPayment = monthlyPayment - interestPayment;

                    yearlyInterest += interestPayment;
                    yearlyPrincipal += principalPayment;
                    remainingBalance -= principalPayment;

                    if (remainingBalance < 0) {
                        yearlyPrincipal += remainingBalance;
                        remainingBalance = 0;
                    }
                }

                yearlyData.push({
                    year: year,
                    yearlyPayment: monthlyPayment * 12,
                    yearlyPrincipal: yearlyPrincipal,
                    yearlyInterest: yearlyInterest,
                    remainingBalance: Math.max(0, remainingBalance),
                    loanDeduction: calculateLoanDeduction(Math.max(0, remainingBalance), year, hasDeduction)
                });

                if (remainingBalance <= 0) break;
            }

            return yearlyData;
        }

        // ãƒ­ãƒ¼ãƒ³è¨ˆç®—ã‚’å®Ÿè¡Œ
        function calculateLoan() {
            const loanAmount = parseFloat(document.getElementById('loanAmount').value);
            const annualRate = parseFloat(document.getElementById('annualRate').value);
            const years = parseInt(document.getElementById('years').value);
            const hasDeduction = document.getElementById('hasDeduction').checked;

            if (!loanAmount || !annualRate || !years) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // æœˆé¡è¿”æ¸ˆé¡ã‚’è¨ˆç®—
            const monthlyPayment = calculateMonthlyPayment(loanAmount, annualRate, years);
            
            // å¹´ã”ã¨ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’è¨ˆç®—
            const yearlyData = calculateYearlyBalance(loanAmount, monthlyPayment, annualRate, years, hasDeduction);

            // çµæœã‚’è¡¨ç¤º
            displayResults(loanAmount, annualRate, years, hasDeduction, monthlyPayment, yearlyData);
        }

        // çµæœã‚’è¡¨ç¤º
        function displayResults(loanAmount, annualRate, years, hasDeduction, monthlyPayment, yearlyData) {
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            currentYearlyData = yearlyData;
            
            // ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’è¨ˆç®—
            const totalPayments = yearlyData.reduce((sum, data) => sum + data.yearlyPayment, 0);
            const totalInterest = yearlyData.reduce((sum, data) => sum + data.yearlyInterest, 0);
            const totalDeduction = yearlyData.reduce((sum, data) => sum + data.loanDeduction, 0);

            // ã‚µãƒãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            document.getElementById('resultsSummaryText').textContent = 
                `å€Ÿå…¥é‡‘é¡: ${formatNumber(loanAmount)}å†† / å¹´åˆ©ç‡: ${annualRate}% / å€Ÿå…¥æœŸé–“: ${years}å¹´`;

            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
            document.getElementById('monthlyPayment').textContent = formatNumber(monthlyPayment) + 'å††';
            document.getElementById('totalPayment').textContent = formatNumber(totalPayments) + 'å††';
            document.getElementById('totalInterest').textContent = formatNumber(totalInterest) + 'å††';
            
            if (hasDeduction) {
                document.getElementById('totalDeduction').textContent = formatNumber(totalDeduction) + 'å††';
                document.getElementById('actualPayment').textContent = formatNumber(totalPayments - totalDeduction) + 'å††';
            } else {
                document.getElementById('totalDeduction').textContent = 'é©ç”¨ãªã—';
                document.getElementById('actualPayment').textContent = formatNumber(totalPayments) + 'å††';
            }

            // ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤è©³ç´°ã‚’è¡¨ç¤º
            if (hasDeduction) {
                const data13Years = yearlyData.slice(0, Math.min(13, yearlyData.length));
                const payments13Years = data13Years.reduce((sum, data) => sum + data.yearlyPayment, 0);
                const interest13Years = data13Years.reduce((sum, data) => sum + data.yearlyInterest, 0);
                const deduction13Years = data13Years.reduce((sum, data) => sum + data.loanDeduction, 0);
                
                document.getElementById('deduction13TotalPayment').textContent = formatNumber(payments13Years) + 'å††';
                document.getElementById('deduction13TotalInterest').textContent = formatNumber(interest13Years) + 'å††';
                document.getElementById('deduction13TotalDeduction').textContent = formatNumber(deduction13Years) + 'å††';
                document.getElementById('deduction13ActualPayment').textContent = formatNumber(payments13Years - deduction13Years) + 'å††';
                
                if (yearlyData.length >= 13) {
                    document.getElementById('deduction13RemainingBalance').textContent = formatNumber(yearlyData[12].remainingBalance) + 'å††';
                } else {
                    document.getElementById('deduction13RemainingBalance').textContent = '0å††';
                }
                
                document.getElementById('deductionSummary').style.display = 'block';
            } else {
                document.getElementById('deductionSummary').style.display = 'none';
            }

            // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
            updateResultsTable(yearlyData, hasDeduction);

            // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('results').style.display = 'block';
        }

        // çµæœãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        function updateResultsTable(yearlyData, hasDeduction) {
            const tbody = document.getElementById('resultsTableBody');
            const deductionColumn = document.getElementById('deductionColumn');
            
            // æ§é™¤åˆ—ã®è¡¨ç¤º/éè¡¨ç¤º
            deductionColumn.style.display = hasDeduction ? '' : 'none';
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’ã‚¯ãƒªã‚¢
            tbody.innerHTML = '';
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            yearlyData.forEach(data => {
                const row = document.createElement('tr');
                
                let html = `
                    <td>${data.year}</td>
                    <td>${formatNumber(data.yearlyPayment)}å††</td>
                    <td>${formatNumber(data.yearlyPrincipal)}å††</td>
                    <td>${formatNumber(data.yearlyInterest)}å††</td>
                    <td>${formatNumber(data.remainingBalance)}å††</td>
                `;
                
                if (hasDeduction) {
                    html += `<td>${formatNumber(data.loanDeduction)}å††</td>`;
                }
                
                row.innerHTML = html;
                tbody.appendChild(row);
            });
        }

        // CSVå‡ºåŠ›æ©Ÿèƒ½
        function exportToCSV() {
            if (!currentYearlyData) {
                alert('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const hasDeduction = document.getElementById('hasDeduction').checked;
            let csvContent = hasDeduction 
                ? "å¹´,å¹´é–“è¿”æ¸ˆé¡,å…ƒæœ¬è¿”æ¸ˆé¡,åˆ©æ¯æ”¯æ‰•é¡,æ®‹å‚µé¡,ä½å®…ãƒ­ãƒ¼ãƒ³æ§é™¤\n"
                : "å¹´,å¹´é–“è¿”æ¸ˆé¡,å…ƒæœ¬è¿”æ¸ˆé¡,åˆ©æ¯æ”¯æ‰•é¡,æ®‹å‚µé¡\n";

            currentYearlyData.forEach(data => {
                let row = `${data.year},${Math.round(data.yearlyPayment)},${Math.round(data.yearlyPrincipal)},${Math.round(data.yearlyInterest)},${Math.round(data.remainingBalance)}`;
                if (hasDeduction) {
                    row += `,${Math.round(data.loanDeduction)}`;
                }
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'loan_calculation_result.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ã‚°ãƒ©ãƒ•è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
        function toggleChart() {
            const container = document.getElementById('chartContainer');
            const button = document.getElementById('chartToggleBtn');
            
            if (container.style.display === 'none') {
                if (!currentYearlyData) {
                    alert('è¨ˆç®—çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšè¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                container.style.display = 'block';
                button.textContent = 'ğŸ“ˆ ã‚°ãƒ©ãƒ•éè¡¨ç¤º';
                createChart();
            } else {
                container.style.display = 'none';
                button.textContent = 'ğŸ“ˆ ã‚°ãƒ©ãƒ•è¡¨ç¤º';
                if (loanChart) {
                    loanChart.destroy();
                    loanChart = null;
                }
            }
        }

        // ã‚°ãƒ©ãƒ•ä½œæˆ
        function createChart() {
            const ctx = document.getElementById('loanChart').getContext('2d');
            
            if (loanChart) {
                loanChart.destroy();
            }

            const years = currentYearlyData.map(data => data.year);
            const remainingBalance = currentYearlyData.map(data => data.remainingBalance);
            const yearlyInterest = currentYearlyData.map(data => data.yearlyInterest);
            const yearlyPrincipal = currentYearlyData.map(data => data.yearlyPrincipal);

            loanChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'æ®‹å‚µé¡',
                            data: remainingBalance,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'å¹´é–“åˆ©æ¯é¡',
                            data: yearlyInterest,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            fill: false,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'å¹´é–“å…ƒæœ¬è¿”æ¸ˆé¡',
                            data: yearlyPrincipal,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'å¹´æ•°'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'æ®‹å‚µé¡ï¼ˆå††ï¼‰'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'å††';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'å¹´é–“é‡‘é¡ï¼ˆå††ï¼‰'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + 'å††';
                                }
                            }
                        },
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'ãƒ­ãƒ¼ãƒ³è¿”æ¸ˆæ¨ç§»ã‚°ãƒ©ãƒ•'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'å††';
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>